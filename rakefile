require 'rubygems'
require 'albacore'
  
 task :default =>['plasma:build_and_test']
 
 namespace :plasma do
	
	def write_assembly_info project_path
		asm = AssemblyInfo.new
		asm.output_file = "#{project_path}/Properties/AssemblyInfo.cs"
		asm.title = "Plasma.Core"
		asm.description = "Plasma provides web automation and testing capabilities to ASP.NET projects."
		asm.copyright = "Copyright 2011"
		asm.company_name = "n/a"
		asm.product_name = "Plasma"
		asm.trademark = ""
		asm.com_visible = false
		asm.version = "1.1.0.0"
		asm.file_version = "1.1.0.0"
		asm.execute
	end
	
    desc "Build project and run tests"
    task :build_and_test => ['plasma:all_assembly_info', 'plasma:msbuild', 'plasma:nunit']
		
    desc "Build solution with MSBuild"
    msbuild do |msb|
		msb.properties :configuration => :Debug
        msb.targets [:Clean, :Build]
        msb.solution = "Plasma.sln"
    end
	
	task :all_assembly_info do |task|
		write_assembly_info "src/Plasma.Core"
		write_assembly_info "src/Plasma.Samples.NUnitTestLibrary"
		write_assembly_info "src/Plasma.Samples.MSTestLibrary"
	end
	task :create_output_folders do
		Dir.mkdir "build" if !Dir.exists?"build"
		Dir.mkdir "build/Results" if !Dir.exists?"build/Results"
	end
    desc "Update assembly info"
    assemblyinfo :assemblyinfo do |asm, args|
		puts args
    end
	
	nunit :nunit => [:msbuild, :create_output_folders] do |nunit|
		nunit.command = "tools/Nunit-2.5.8/nunit-console.exe"
		nunit.assemblies "src/Plasma.Samples.NUnitTestLibrary/Plasma.Samples.NUnitTestLibrary.csproj"	
		nunit.options '/xml=build/Results/Plasma.Samples.NUnitTestLibrary-results.xml'
	end
end