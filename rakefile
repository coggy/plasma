require 'rubygems'
require 'albacore'
  
 task :default =>['plasma:build_and_test']
 
 namespace :plasma do
	$hg_hash = `hg tip --template "{node|short}"`
	$hg_rev = `hg tip --template "{rev}"`
	
	def get_version_number
		(File.read "version.txt").strip
	end
	
	$base_version = get_version_number
	$version =  "#{$base_version}.0"
	
	def write_assembly_info project_path
		asm = AssemblyInfo.new
		asm.output_file = "#{project_path}/Properties/VersionInfo.cs"
		asm.version = $version
		asm.file_version = "#{$base_version}.#{$hg_rev}"
		asm.custom_attributes :AssemblyInformationalVersion =>  "#{$base_version} Alpha (#{$hg_rev} #{$hg_hash})"
		asm.execute
	end
	
    desc "Build project and run tests"
    task :build_and_test => ['plasma:check_headers', 'plasma:all_assembly_info', 'plasma:msbuild', 'plasma:all_tests']
		
	desc "Builds, tests and packages a release"
	task :package_release =>['plasma:build_and_test', 'plasma:zip']
	
	desc "Copies built files to release folder"
	task :copy_to_release_folder => ['plasma:build_and_test'] do |task|
		cp "src/Plasma.Core/bin/Debug/Plasma.Core.dll", "build/Plasma-#{$version}/bin"
		cp "src/Plasma.Core/bin/Debug/Plasma.Core.pdb", "build/Plasma-#{$version}/bin"
		cp "src/Plasma.WebDriver/bin/Debug/Plasma.WebDriver.dll", "build/Plasma-#{$version}/bin"
		cp "src/Plasma.WebDriver/bin/Debug/Plasma.WebDriver.pdb", "build/Plasma-#{$version}/bin"
		cp "lib/WebDriver/WebDriver.Common.dll", "build/Plasma-#{$version}/lib"
		cp "license.txt", "build/Plasma-#{$version}/"
		cp "license.htm", "build/Plasma-#{$version}/"
		cp "readme.txt", "build/Plasma-#{$version}/"
	end
	
	desc "Zip into archive"
	zip :zip => [:copy_to_release_folder] do |zip|
		zip.directories_to_zip = ["build/Plasma-#{$version}"]
		zip.output_file = "Plasma-#{$version}.zip"
		zip.output_path = "build"
	end
	
	
    desc "Build solution with MSBuild"
    msbuild do |msb|
		msb.properties :configuration => :Debug, :SkipDefaultVersion => :True
        msb.targets [:Clean, :Build]
        msb.solution = "Plasma.sln"
    end
	
	task :all_assembly_info do |task|
		write_assembly_info "src/Plasma.Core"
	end
	task :create_output_folders do
		if File.directory? "build" then remove_dir "build" end
		mkdir_p "build"
		mkdir_p "build/results"
		mkdir_p "build/Plasma-#{$version}/bin"
		mkdir_p "build/Plasma-#{$version}/lib"
	end
    desc "Update assembly info"
    assemblyinfo :assemblyinfo do |asm, args|
		puts args
    end
	desc "All tests"
	task :all_tests => [:unit_tests, :functional_tests]
	nunit :functional_tests => [:msbuild, :create_output_folders] do |nunit|
		nunit.command = "tools/Nunit-2.5.9/nunit-console.exe"
		nunit.assemblies "src/Plasma.Test.Functional/Plasma.Test.Functional.csproj"	
		nunit.options '/xml=build/Results/Plasma.Test.Functional.xml'
	end
	nunit :unit_tests => [:msbuild, :create_output_folders] do |nunit|
		nunit.command = "tools/Nunit-2.5.9/nunit-console.exe"
		nunit.assemblies "src/Plasma.Test.Unit/Plasma.Test.Unit.csproj"	
		nunit.options '/xml=build/Results/Plasma.Test.Unit.xml'
	end
	task :check_headers do
		microsoft_header = "Copyright (c) Microsoft Corporation. All rights reserved." 
		thoughtworks_header = "Copyright 2010 ThoughtWorks, Inc."
			ignore = [/AssemblyInfo\.cs/, /\.designer\.cs/, /VersionInfo/]
		need_headers = []
		all_files =	Dir.glob("src/**/*.cs")
		all_files.each do |file|
			if !ignore.any? {|x| file.match x}
				contents = File.read(file)
				need_headers.push file unless contents.include?(microsoft_header) || contents.include?(thoughtworks_header)
			end
		end
		fail "Headers required for : " + need_headers.join("\n") if(need_headers.length>0)
 end
end
